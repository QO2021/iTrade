{% extends "base.html" %}

{% block title %}Dashboard - iPortfolio.com{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1><i class="fas fa-tachometer-alt text-primary me-2"></i>Portfolio Dashboard</h1>
        <p class="text-muted">Welcome back, {{ current_user.username }}! Monitor your investments and market conditions.</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="btn-group" role="group">
            <a href="{{ url_for('create_portfolio') }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>New Portfolio
            </a>
            <a href="{{ url_for('trade') }}" class="btn btn-success">
                <i class="fas fa-exchange-alt me-1"></i>Trade
            </a>
        </div>
    </div>
</div>

<!-- Market Overview -->
{% if market_data %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-globe me-2"></i>Market Overview</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for index, data in market_data.items() %}
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light text-center">
                            <div class="card-body">
                                <h6 class="card-title">
                                    {% if index == '^GSPC' %}S&P 500
                                    {% elif index == '^DJI' %}Dow Jones
                                    {% elif index == '^IXIC' %}NASDAQ
                                    {% elif index == '^VIX' %}VIX
                                    {% else %}{{ index }}
                                    {% endif %}
                                </h6>
                                <h5 class="{% if data.change_pct > 0 %}text-success{% elif data.change_pct < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {{ "%.2f"|format(data.price) }}
                                </h5>
                                <small class="{% if data.change_pct > 0 %}text-success{% elif data.change_pct < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {% if data.change_pct > 0 %}+{% endif %}{{ "%.2f"|format(data.change_pct) }}%
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- User Portfolios -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-briefcase me-2"></i>Your Portfolios</h5>
                <span class="badge bg-primary">{{ portfolios|length }} Portfolio{{ 's' if portfolios|length != 1 else '' }}</span>
            </div>
            <div class="card-body">
                {% if portfolios %}
                <div class="row">
                    {% for portfolio in portfolios %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100 portfolio-card">
                            <div class="card-body">
                                <h6 class="card-title">{{ portfolio.name }}</h6>
                                <p class="card-text">
                                    <small class="text-muted">Target Volatility: {{ "%.1f"|format(portfolio.target_volatility) }}%</small><br>
                                    <small class="text-muted">Created: {{ portfolio.created_at.strftime('%m/%d/%Y') }}</small>
                                </p>
                                <div class="d-grid gap-2">
                                    <a href="{{ url_for('portfolio_detail', portfolio_id=portfolio.id) }}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-eye me-1"></i>View Details
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-briefcase fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No portfolios yet</h5>
                    <p class="text-muted">Create your first optimized portfolio to get started</p>
                    <a href="{{ url_for('create_portfolio') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Create Your First Portfolio
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Stock Search -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-search me-2"></i>Stock Analysis</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="text" id="stock-search" class="form-control" 
                                   placeholder="Search for stocks (e.g., AAPL, GOOGL, MSFT, TSLA)">
                            <button class="btn btn-primary" type="button" id="search-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div id="search-results" class="mt-2"></div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('analysis') }}" class="btn btn-info">
                                <i class="fas fa-chart-area me-2"></i>Market Analysis
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Economic Indicators -->
{% if economic_data %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Key Economic Indicators</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% if economic_data.cpi %}
                    <div class="col-md-2 mb-3">
                        <div class="text-center">
                            <h6 class="text-muted">CPI</h6>
                            <h5 class="text-primary">{{ "%.1f"|format(economic_data.cpi.current) }}</h5>
                            {% if economic_data.cpi.change %}
                            <small class="{% if economic_data.cpi.change > 0 %}text-danger{% else %}text-success{% endif %}">
                                {{ "%.2f"|format(economic_data.cpi.change) }}
                            </small>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if economic_data.unemployment %}
                    <div class="col-md-2 mb-3">
                        <div class="text-center">
                            <h6 class="text-muted">Unemployment</h6>
                            <h5 class="text-info">{{ "%.1f"|format(economic_data.unemployment.current) }}%</h5>
                            {% if economic_data.unemployment.change %}
                            <small class="{% if economic_data.unemployment.change > 0 %}text-danger{% else %}text-success{% endif %}">
                                {{ "%.2f"|format(economic_data.unemployment.change) }}%
                            </small>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if economic_data.interest_rate %}
                    <div class="col-md-2 mb-3">
                        <div class="text-center">
                            <h6 class="text-muted">Fed Rate</h6>
                            <h5 class="text-warning">{{ "%.2f"|format(economic_data.interest_rate.current) }}%</h5>
                            {% if economic_data.interest_rate.change %}
                            <small class="{% if economic_data.interest_rate.change > 0 %}text-danger{% else %}text-success{% endif %}">
                                {{ "%.2f"|format(economic_data.interest_rate.change) }}%
                            </small>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if economic_data.vix %}
                    <div class="col-md-2 mb-3">
                        <div class="text-center">
                            <h6 class="text-muted">VIX</h6>
                            <h5 class="text-danger">{{ "%.1f"|format(economic_data.vix.current) }}</h5>
                            {% if economic_data.vix.previous %}
                            <small class="{% if economic_data.vix.current > economic_data.vix.previous %}text-danger{% else %}text-success{% endif %}">
                                {{ "%.1f"|format(economic_data.vix.current - economic_data.vix.previous) }}
                            </small>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if economic_data.gold %}
                    <div class="col-md-2 mb-3">
                        <div class="text-center">
                            <h6 class="text-muted">Gold</h6>
                            <h5 class="text-warning">${{ "%.0f"|format(economic_data.gold.current) }}</h5>
                            {% if economic_data.gold.previous %}
                            <small class="{% if economic_data.gold.current > economic_data.gold.previous %}text-success{% else %}text-danger{% endif %}">
                                ${{ "%.0f"|format(economic_data.gold.current - economic_data.gold.previous) }}
                            </small>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if economic_data.oil %}
                    <div class="col-md-2 mb-3">
                        <div class="text-center">
                            <h6 class="text-muted">Oil (WTI)</h6>
                            <h5 class="text-dark">${{ "%.1f"|format(economic_data.oil.current) }}</h5>
                            {% if economic_data.oil.previous %}
                            <small class="{% if economic_data.oil.current > economic_data.oil.previous %}text-success{% else %}text-danger{% endif %}">
                                ${{ "%.1f"|format(economic_data.oil.current - economic_data.oil.previous) }}
                            </small>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="text-center mt-3">
                    <a href="{{ url_for('analysis') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-chart-line me-1"></i>View Full Analysis
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="d-grid">
                            <a href="{{ url_for('create_portfolio') }}" class="btn btn-primary">
                                <i class="fas fa-plus mb-2"></i><br>
                                Create Portfolio
                            </a>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <a href="{{ url_for('trade') }}" class="btn btn-success">
                                <i class="fas fa-exchange-alt mb-2"></i><br>
                                Execute Trade
                            </a>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <a href="{{ url_for('analysis') }}" class="btn btn-info">
                                <i class="fas fa-chart-area mb-2"></i><br>
                                Market Analysis
                            </a>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <a href="{{ url_for('trades') }}" class="btn btn-secondary">
                                <i class="fas fa-history mb-2"></i><br>
                                Trade History
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Stock search functionality
    const searchInput = document.getElementById('stock-search');
    const searchBtn = document.getElementById('search-btn');
    const searchResults = document.getElementById('search-results');

    function performSearch() {
        const query = searchInput.value.trim();
        if (query.length < 1) {
            searchResults.innerHTML = '';
            return;
        }

        fetch(`/api/stock_search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    const resultsHtml = data.map(stock => 
                        `<div class="list-group-item list-group-item-action" onclick="viewStock('${stock.symbol}')">
                            <strong>${stock.symbol}</strong> - ${stock.name}
                        </div>`
                    ).join('');
                    searchResults.innerHTML = `<div class="list-group">${resultsHtml}</div>`;
                } else {
                    searchResults.innerHTML = '<small class="text-muted">No results found</small>';
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                searchResults.innerHTML = '<small class="text-danger">Search error occurred</small>';
            });
    }

    searchInput.addEventListener('input', performSearch);
    searchBtn.addEventListener('click', performSearch);
    
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (query) {
                window.location.href = `/stock/${query.toUpperCase()}`;
            }
        }
    });

    // Update time display
    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleString();
        const timeElement = document.getElementById('current-time');
        if (timeElement) {
            timeElement.textContent = timeString;
        }
    }
    
    updateTime();
    setInterval(updateTime, 1000);

    // Add hover effects to portfolio cards
    const portfolioCards = document.querySelectorAll('.portfolio-card');
    portfolioCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.transition = 'transform 0.2s';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});

function viewStock(symbol) {
    window.location.href = `/stock/${symbol}`;
}

// Auto-refresh economic data every 5 minutes
setInterval(() => {
    window.location.reload();
}, 300000);
</script>

<style>
.portfolio-card {
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
}

.portfolio-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.list-group-item {
    cursor: pointer;
}

.list-group-item:hover {
    background-color: #f8f9fa;
}

.btn {
    transition: all 0.2s;
}

.btn:hover {
    transform: translateY(-1px);
}

.card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#current-time {
    font-family: 'Courier New', monospace;
}
</style>
{% endblock %}