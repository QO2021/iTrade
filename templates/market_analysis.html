{% extends "base.html" %}

{% block title %}Market Analysis - iTrade.com{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-area me-2"></i>Comprehensive Market Analysis
        </h1>
        <p class="text-muted mb-4">AI-powered market insights combining economic indicators, news analysis, and correlation data.</p>
    </div>
</div>

<!-- Economic Indicators Dashboard -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Current Economic Indicators
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {% if economic_data.vix %}
                    <div class="col-md-2">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1 {% if economic_data.vix > 30 %}text-danger{% elif economic_data.vix > 20 %}text-warning{% else %}text-success{% endif %}">
                                {{ "%.2f"|format(economic_data.vix) }}
                            </div>
                            <small class="text-muted">VIX (Volatility)</small>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if economic_data.interest_rate %}
                    <div class="col-md-2">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1 text-info">
                                {{ "%.2f"|format(economic_data.interest_rate) }}%
                            </div>
                            <small class="text-muted">Fed Funds Rate</small>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if economic_data.unemployment %}
                    <div class="col-md-2">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1 {% if economic_data.unemployment > 6 %}text-danger{% elif economic_data.unemployment > 4 %}text-warning{% else %}text-success{% endif %}">
                                {{ "%.1f"|format(economic_data.unemployment) }}%
                            </div>
                            <small class="text-muted">Unemployment</small>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if economic_data.bond_yield %}
                    <div class="col-md-2">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1 text-primary">
                                {{ "%.2f"|format(economic_data.bond_yield) }}%
                            </div>
                            <small class="text-muted">10Y Bond Yield</small>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if economic_data.cpi %}
                    <div class="col-md-2">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1 text-secondary">
                                {{ "%.1f"|format(economic_data.cpi) }}
                            </div>
                            <small class="text-muted">CPI Index</small>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if economic_data.house_price %}
                    <div class="col-md-2">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 mb-1 text-success">
                                {{ "%.0f"|format(economic_data.house_price) }}
                            </div>
                            <small class="text-muted">House Price Index</small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Market Sentiment Analysis -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-brain me-2"></i>AI Market Sentiment Analysis
                </h5>
            </div>
            <div class="card-body">
                {% if symbols %}
                <div class="mb-3">
                    <h6 class="text-muted">Analyzing: 
                        {% for symbol in symbols %}
                            <span class="badge bg-primary me-1">{{ symbol }}</span>
                        {% endfor %}
                    </h6>
                </div>
                {% endif %}
                
                <div class="news-analysis">
                    {{ news_analysis|safe|replace('\n', '<br>')|replace('**', '<strong>')|replace('**', '</strong>') }}
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Analysis generated using AI based on current market conditions and economic indicators.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Correlation Analysis -->
{% if correlation_data and correlation_data.symbols %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-project-diagram me-2"></i>Stock Correlation Matrix
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Correlation analysis shows how stocks move in relation to each other. High positive correlation means stocks tend to move together.</p>
                
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Stock</th>
                                {% for symbol in correlation_data.symbols %}
                                <th class="text-center">{{ symbol }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row_symbol in correlation_data.symbols %}
                            <tr>
                                <td><strong>{{ row_symbol }}</strong></td>
                                {% for col_symbol in correlation_data.symbols %}
                                {% set correlation = correlation_data.price_correlation[row_symbol][col_symbol] %}
                                <td class="text-center
                                    {% if correlation|abs >= 0.7 %}
                                        {% if correlation > 0 %}bg-success text-white{% else %}bg-danger text-white{% endif %}
                                    {% elif correlation|abs >= 0.3 %}
                                        {% if correlation > 0 %}bg-warning{% else %}bg-info text-white{% endif %}
                                    {% endif %}">
                                    {{ "%.3f"|format(correlation) }}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="alert alert-light">
                                <h6 class="alert-heading">Legend:</h6>
                                <div class="d-flex align-items-center mb-1">
                                    <div class="bg-success text-white px-2 py-1 rounded me-2" style="width: 30px; text-align: center;">0.7+</div>
                                    <small>Strong positive correlation</small>
                                </div>
                                <div class="d-flex align-items-center mb-1">
                                    <div class="bg-warning px-2 py-1 rounded me-2" style="width: 30px; text-align: center;">0.3-0.7</div>
                                    <small>Moderate positive correlation</small>
                                </div>
                                <div class="d-flex align-items-center mb-1">
                                    <div class="bg-info text-white px-2 py-1 rounded me-2" style="width: 30px; text-align: center;">-0.3</div>
                                    <small>Moderate negative correlation</small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="bg-danger text-white px-2 py-1 rounded me-2" style="width: 30px; text-align: center;">-0.7</div>
                                    <small>Strong negative correlation</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <h6 class="alert-heading">Diversification Tip:</h6>
                                <p class="mb-0">
                                    <small>Look for stocks with low or negative correlations to build a well-diversified portfolio. 
                                    This helps reduce overall portfolio risk.</small>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Market Risk Assessment -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Risk Assessment
                </h5>
            </div>
            <div class="card-body">
                {% if economic_data.vix %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Market Volatility (VIX)</span>
                        <span class="badge {% if economic_data.vix > 30 %}bg-danger{% elif economic_data.vix > 20 %}bg-warning{% else %}bg-success{% endif %}">
                            {{ "%.1f"|format(economic_data.vix) }}
                        </span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar {% if economic_data.vix > 30 %}bg-danger{% elif economic_data.vix > 20 %}bg-warning{% else %}bg-success{% endif %}" 
                             style="width: {{ (economic_data.vix / 50 * 100)|min(100) }}%"></div>
                    </div>
                    <small class="text-muted">
                        {% if economic_data.vix > 30 %}High volatility - Increased market uncertainty
                        {% elif economic_data.vix > 20 %}Moderate volatility - Some market uncertainty
                        {% else %}Low volatility - Relatively stable market conditions
                        {% endif %}
                    </small>
                </div>
                {% endif %}
                
                {% if economic_data.unemployment %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Economic Risk (Unemployment)</span>
                        <span class="badge {% if economic_data.unemployment > 6 %}bg-danger{% elif economic_data.unemployment > 4 %}bg-warning{% else %}bg-success{% endif %}">
                            {{ "%.1f"|format(economic_data.unemployment) }}%
                        </span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar {% if economic_data.unemployment > 6 %}bg-danger{% elif economic_data.unemployment > 4 %}bg-warning{% else %}bg-success{% endif %}" 
                             style="width: {{ (economic_data.unemployment / 10 * 100)|min(100) }}%"></div>
                    </div>
                    <small class="text-muted">
                        {% if economic_data.unemployment > 6 %}High unemployment - Economic concerns
                        {% elif economic_data.unemployment > 4 %}Moderate unemployment - Watch economic trends
                        {% else %}Low unemployment - Strong economic conditions
                        {% endif %}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Investment Insights
                </h5>
            </div>
            <div class="card-body">
                <div class="insight-item mb-3">
                    <h6 class="text-primary">
                        <i class="fas fa-chart-line me-1"></i>Market Outlook
                    </h6>
                    {% if economic_data.vix %}
                        {% if economic_data.vix > 30 %}
                        <p class="small text-muted mb-0">High volatility suggests increased caution. Consider defensive positions and diversification.</p>
                        {% elif economic_data.vix > 20 %}
                        <p class="small text-muted mb-0">Moderate volatility indicates some uncertainty. Balanced approach recommended.</p>
                        {% else %}
                        <p class="small text-muted mb-0">Low volatility suggests stable conditions. May be good time for growth positions.</p>
                        {% endif %}
                    {% endif %}
                </div>
                
                <div class="insight-item mb-3">
                    <h6 class="text-success">
                        <i class="fas fa-balance-scale me-1"></i>Portfolio Balance
                    </h6>
                    <p class="small text-muted mb-0">Based on correlation analysis, ensure proper diversification across uncorrelated assets.</p>
                </div>
                
                <div class="insight-item">
                    <h6 class="text-info">
                        <i class="fas fa-clock me-1"></i>Timing Considerations
                    </h6>
                    {% if economic_data.interest_rate %}
                        {% if economic_data.interest_rate > 4 %}
                        <p class="small text-muted mb-0">High interest rates may favor value stocks and bonds over growth stocks.</p>
                        {% else %}
                        <p class="small text-muted mb-0">Lower interest rates generally support growth stocks and equity markets.</p>
                        {% endif %}
                    {% else %}
                    <p class="small text-muted mb-0">Monitor Federal Reserve policy changes for timing decisions.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Action Buttons -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title mb-3">Take Action</h5>
                <div class="d-flex flex-wrap justify-content-center gap-3">
                    <a href="{{ url_for('trade') }}" class="btn btn-success">
                        <i class="fas fa-exchange-alt me-2"></i>Execute Trade
                    </a>
                    <a href="{{ url_for('portfolio') }}" class="btn btn-primary">
                        <i class="fas fa-briefcase me-2"></i>View Portfolio
                    </a>
                    <a href="{{ url_for('correlation_analysis') }}" class="btn btn-info">
                        <i class="fas fa-chart-line me-2"></i>Detailed Correlation
                    </a>
                    <button class="btn btn-secondary" onclick="window.location.reload();">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh every 5 minutes
    setTimeout(function() {
        window.location.reload();
    }, 300000);
    
    // Add tooltips for better UX
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(tooltip => {
        new bootstrap.Tooltip(tooltip);
    });
});
</script>
{% endblock %}