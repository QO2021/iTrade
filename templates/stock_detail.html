{% extends "base.html" %}

{% block title %}{{ symbol }} - Stock Details - iTrade{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                <span id="stock-name">{{ symbol }}</span> (<span id="stock-symbol">{{ symbol }}</span>)
            </h1>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                Real-time stock data and analysis
            </p>
        </div>
        <div class="mt-4 sm:mt-0 flex space-x-2">
            <button id="add-to-watchlist" class="btn-primary inline-flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
                Add to Watchlist
            </button>
        </div>
    </div>

    <!-- Stock Overview -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Price and Chart -->
        <div class="lg:col-span-2">
            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                        Price Chart
                    </h2>
                    <div class="flex space-x-1">
                        <button onclick="changeTimeframe('1d')" class="timeframe-btn active px-3 py-1 text-sm rounded-md">1D</button>
                        <button onclick="changeTimeframe('5d')" class="timeframe-btn px-3 py-1 text-sm rounded-md">5D</button>
                        <button onclick="changeTimeframe('1mo')" class="timeframe-btn px-3 py-1 text-sm rounded-md">1M</button>
                        <button onclick="changeTimeframe('3mo')" class="timeframe-btn px-3 py-1 text-sm rounded-md">3M</button>
                        <button onclick="changeTimeframe('1y')" class="timeframe-btn px-3 py-1 text-sm rounded-md">1Y</button>
                    </div>
                </div>
                <div class="mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p id="stock-price" class="text-3xl font-bold text-gray-900 dark:text-gray-100">Loading...</p>
                            <div id="stock-change" class="flex items-center">
                                <span class="loading"></span>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Previous Close</p>
                            <p id="previous-close" class="font-semibold text-gray-900 dark:text-gray-100">Loading...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Chart -->
                <div id="stock-chart" class="h-64">
                    <div class="flex items-center justify-center h-full">
                        <div class="loading"></div>
                        <span class="ml-2 text-gray-500 dark:text-gray-400">Loading chart...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock Stats -->
        <div class="space-y-6">
            <div class="card p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">
                    Key Statistics
                </h3>
                <div id="stock-stats" class="space-y-4">
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Open</span>
                        <span id="stock-open" class="font-semibold">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">High</span>
                        <span id="stock-high" class="font-semibold">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Low</span>
                        <span id="stock-low" class="font-semibold">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Volume</span>
                        <span id="stock-volume" class="font-semibold">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Market Cap</span>
                        <span id="stock-market-cap" class="font-semibold">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">P/E Ratio</span>
                        <span id="stock-pe-ratio" class="font-semibold">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Dividend Yield</span>
                        <span id="stock-dividend-yield" class="font-semibold">Loading...</span>
                    </div>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">
                    52 Week Range
                </h3>
                <div id="stock-range" class="space-y-4">
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">High</span>
                        <span id="stock-52w-high" class="font-semibold">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Low</span>
                        <span id="stock-52w-low" class="font-semibold">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- News Section -->
    <div class="card p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">
            Latest News
        </h2>
        <div id="stock-news">
            <div class="text-center py-8">
                <div class="loading mx-auto"></div>
                <p class="text-gray-500 dark:text-gray-400 mt-2">Loading news...</p>
            </div>
        </div>
    </div>
</div>

<script>
let currentTimeframe = '1mo';
let stockData = null;

// Format currency
function formatCurrency(amount) {
    if (amount === null || amount === undefined) return 'N/A';
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
    }).format(amount);
}

// Format number
function formatNumber(num) {
    if (num === null || num === undefined) return 'N/A';
    return new Intl.NumberFormat('en-US').format(num);
}

// Format market cap
function formatMarketCap(marketCap) {
    if (!marketCap) return 'N/A';
    const billion = 1000000000;
    const million = 1000000;
    
    if (marketCap >= billion) {
        return `$${(marketCap / billion).toFixed(2)}B`;
    } else if (marketCap >= million) {
        return `$${(marketCap / million).toFixed(2)}M`;
    } else {
        return formatCurrency(marketCap);
    }
}

// Load stock data
async function loadStockData() {
    try {
        const response = await fetch(`/api/stocks/quote/{{ symbol }}`);
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        stockData = data;
        updateStockDisplay(data);
        createChart(data);
        loadStockNews();
    } catch (error) {
        console.error('Error loading stock data:', error);
        document.getElementById('stock-price').textContent = 'Error loading data';
    }
}

// Update stock display
function updateStockDisplay(data) {
    document.getElementById('stock-name').textContent = data.name;
    document.getElementById('stock-price').textContent = formatCurrency(data.price);
    document.getElementById('previous-close').textContent = formatCurrency(data.open);
    
    const changeElement = document.getElementById('stock-change');
    const changeColor = data.change_percent >= 0 ? 'market-up' : 'market-down';
    const changeIcon = data.change_percent >= 0 ? '↗' : '↘';
    
    changeElement.innerHTML = `
        <span class="${changeColor}">${changeIcon} ${formatCurrency(data.change)} (${data.change_percent >= 0 ? '+' : ''}${data.change_percent.toFixed(2)}%)</span>
    `;
    
    // Update stats
    document.getElementById('stock-open').textContent = formatCurrency(data.open);
    document.getElementById('stock-high').textContent = formatCurrency(data.high);
    document.getElementById('stock-low').textContent = formatCurrency(data.low);
    document.getElementById('stock-volume').textContent = formatNumber(data.volume);
    document.getElementById('stock-market-cap').textContent = formatMarketCap(data.market_cap);
    document.getElementById('stock-pe-ratio').textContent = data.pe_ratio ? data.pe_ratio.toFixed(2) : 'N/A';
    document.getElementById('stock-dividend-yield').textContent = data.dividend_yield ? `${(data.dividend_yield * 100).toFixed(2)}%` : 'N/A';
    
    // 52 week range (using historical data)
    if (data.historical_data && data.historical_data.length > 0) {
        const prices = data.historical_data.map(d => d.Close);
        const high = Math.max(...prices);
        const low = Math.min(...prices);
        
        document.getElementById('stock-52w-high').textContent = formatCurrency(high);
        document.getElementById('stock-52w-low').textContent = formatCurrency(low);
    }
}

// Create chart
function createChart(data) {
    if (!data.historical_data || data.historical_data.length === 0) {
        document.getElementById('stock-chart').innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">No chart data available</p>';
        return;
    }
    
    const chartData = data.historical_data.map(d => ({
        x: new Date(d.Date),
        y: d.Close
    }));
    
    const trace = {
        x: chartData.map(d => d.x),
        y: chartData.map(d => d.y),
        type: 'scatter',
        mode: 'lines',
        line: {
            color: '#667eea',
            width: 2
        },
        fill: 'tonexty',
        fillcolor: 'rgba(102, 126, 234, 0.1)'
    };
    
    const layout = {
        title: `${data.symbol} Stock Price`,
        xaxis: {
            title: 'Date',
            showgrid: true,
            gridcolor: '#e5e7eb'
        },
        yaxis: {
            title: 'Price ($)',
            showgrid: true,
            gridcolor: '#e5e7eb'
        },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)',
        font: {
            color: document.documentElement.classList.contains('dark') ? '#f9fafb' : '#111827'
        }
    };
    
    Plotly.newPlot('stock-chart', [trace], layout, {responsive: true});
}

// Load stock news
async function loadStockNews() {
    try {
        const response = await fetch('/api/news/financial');
        const data = await response.json();
        const container = document.getElementById('stock-news');
        
        if (data.articles && data.articles.length > 0) {
            container.innerHTML = '';
            data.articles.slice(0, 5).forEach(article => {
                const item = document.createElement('div');
                item.className = 'border-b border-gray-200 dark:border-gray-700 pb-4 last:border-b-0 last:pb-0';
                item.innerHTML = `
                    <h3 class="font-semibold text-gray-900 dark:text-gray-100 mb-2">
                        <a href="${article.url}" target="_blank" class="hover:text-blue-600 dark:hover:text-blue-400">
                            ${article.title}
                        </a>
                    </h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                        ${article.description || 'No description available'}
                    </p>
                    <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                        <span>${article.source.name}</span>
                        <span>${new Date(article.publishedAt).toLocaleDateString()}</span>
                    </div>
                `;
                container.appendChild(item);
            });
        } else {
            container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">No news available</p>';
        }
    } catch (error) {
        console.error('Error loading news:', error);
    }
}

// Change timeframe
function changeTimeframe(timeframe) {
    currentTimeframe = timeframe;
    
    // Update active button
    document.querySelectorAll('.timeframe-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
    });
    event.target.classList.add('active', 'bg-blue-600', 'text-white');
    event.target.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
    
    // Reload data with new timeframe
    loadStockData();
}

// Add to watchlist
document.getElementById('add-to-watchlist').addEventListener('click', async function() {
    try {
        const response = await fetch('/api/stocks/watchlist', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ symbol: '{{ symbol }}' })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            this.innerHTML = `
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
                Added to Watchlist
            `;
            this.classList.remove('btn-primary');
            this.classList.add('btn-secondary');
        } else {
            alert(data.error || 'Failed to add to watchlist');
        }
    } catch (error) {
        console.error('Error adding to watchlist:', error);
        alert('Failed to add to watchlist');
    }
});

// Load data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadStockData();
});
</script>

<style>
.timeframe-btn {
    transition: all 0.2s;
}
.timeframe-btn.active {
    background-color: #2563eb;
    color: white;
}
</style>
{% endblock %} 